import {
  Card,
  CardActionArea,
  CardContent,
  CardMedia,
  Dialog,
  DialogTitle,
  Divider,
  Grid,
  Typography,
} from "@mui/material";
import Box from "@mui/material/Box";
import Tooltip from "@mui/material/Tooltip";
import type { NextPage } from "next";
import Head from "next/head";
import React, { useEffect, useState } from "react";
import { PageContainer } from "../../src/global/PageContainer";
import { MultiSelectFilter } from "../../src/global/forms/MultiSelectFilterField";
import { SingleSelectFilterField } from "../../src/global/forms/SingleSelectFilterField";
import { FilterButton } from "../../src/tutorials/components/buttons/FilterButton";
import { SortButton } from "../../src/tutorials/components/buttons/SortButton";
import {
  subTitleShortener,
  titleShortener,
} from "../../src/tutorials/components/cards/textFormatter";
import { filterMetaData } from "../../src/tutorials/components/filters/filterMetaData";
import { sortMetaData } from "../../src/tutorials/components/filters/sortMetaData";
import { getTutorialMetaData } from "../../src/tutorials/tutorialDataService";
import {
  Languages,
  SortOptions,
  Tags,
  Topic,
} from "../../src/tutorials/types";
import { slideTransition } from "../../utils/muiSpecificLogic";
import useDeviceDetect from "../../utils/useDeviceDetect";

const Transition = slideTransition("right");

const Tutorials: NextPage = () => {
  const { isMobile } = useDeviceDetect();
  const tutorialMetaData = getTutorialMetaData();

  const availableTopics: Topic[] = Object.values(Topic);
  const availableLanguages: Languages[] = Object.values(Languages);
  const availableTags: Tags[] = Object.values(Tags);
  const tutorialPurple = "#ce93d8";

  const [sortMetaDataBy, setSortMetaDataBy] = useState(SortOptions.Newest);
  const [sortedMetaData, setSortedMetaData] = useState(tutorialMetaData);

  const [topicFilter, setTopicFilter] = useState<Topic | undefined>(undefined);
  const [filteredLanguages, setFilteredLanguages] = useState([] as Languages[]);
  const [tagsFilter, setTagsFilter] = useState([] as Tags[]);
  const [filteredMetaData, setFilteredData] = useState(sortedMetaData);
  const [showFilterMenu, setShowFilterMenu] = React.useState(false);

  useEffect(() => {
    sortMetaData(tutorialMetaData, sortMetaDataBy, setSortedMetaData);
  }, [sortMetaDataBy, filteredMetaData]);

  useEffect(() => {
    filterMetaData(
      sortedMetaData,
      topicFilter,
      filteredLanguages,
      tagsFilter,
      setFilteredData
    );
  }, [
    filteredLanguages,
    sortedMetaData,
    tagsFilter,
    topicFilter,
    sortMetaDataBy,
  ]);

  const handleCloseFilterMenu = () => {
    setShowFilterMenu(false);
  };

  const filterPopUp = (): JSX.Element => {
    return (
      <Dialog
        open={showFilterMenu}
        TransitionComponent={Transition}
        keepMounted
        onClose={handleCloseFilterMenu}
      >
        <div
          style={
            isMobile
              ? { margin: "10px 0px 50px 0px" }
              : { margin: "20px 50px 50px 50px" }
          }
        >
          <DialogTitle>{"Filter"}</DialogTitle>

          <Divider sx={{ borderColor: tutorialPurple }} />
          <SingleSelectFilterField
            label={"Topic"}
            defaultValue={"All"}
            filter={topicFilter}
            setFilter={setTopicFilter}
            dropDownData={availableTopics}
            highlightColor={tutorialPurple}
          />
          <MultiSelectFilter
            label={"Languages"}
            filter={filteredLanguages}
            setFilter={setFilteredLanguages}
            dropDownData={availableLanguages}
            highlightColor={tutorialPurple}
          />
          <MultiSelectFilter
            label={"Tags"}
            filter={tagsFilter}
            setFilter={setTagsFilter}
            dropDownData={availableTags}
            highlightColor={tutorialPurple}
          />
        </div>
      </Dialog>
    );
  };

  return (
    <div>
      <Head>
        <title>Tutorials</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <PageContainer>
        <div style={{ display: "flex", margin: "10px 30px" }}>
          <SortButton setSortMetaDataBy={setSortMetaDataBy} />
          <FilterButton setShowFilterMenu={setShowFilterMenu} />
        </div>

        <Grid container spacing={3} justifyContent="center">
          {filteredMetaData.map((dataItem) => (
            <Grid item key={dataItem.title}>
              <Card sx={{ maxWidth: 345, boxShadow: 3 }}>
                <CardActionArea>
                  <CardMedia
                    component="img"
                    height="180"
                    alt={dataItem.title}
                    image={dataItem.thumbnail}
                  />
                  <CardContent>
                    <Box
                      sx={{
                        height: "25px",
                        margin: "-35px 0px 0px 0px",
                        padding: "0px 15px",
                        border: `2px solid ${tutorialPurple}`,
                        borderRadius: 6,
                        position: "absolute",
                        backgroundColor: "background.paper",
                        boxShadow: 2,
                      }}
                    >
                      <Typography
                        variant="body2"
                        align="right"
                        sx={{ fontWeight: 200 }}
                      >
                        {dataItem.topic}
                      </Typography>
                    </Box>
                    <Typography gutterBottom variant="h5">
                      {titleShortener(dataItem.title)}
                    </Typography>
                    <Tooltip
                      title={dataItem.subTitle}
                      followCursor
                      enterDelay={200}
                    >
                      <Typography
                        variant="body2"
                        color="text.secondary"
                        sx={{ paddingLeft: "5px", fontWeight: 200 }}
                      >
                        {subTitleShortener(dataItem.subTitle)}
                      </Typography>
                    </Tooltip>
                  </CardContent>
                </CardActionArea>
              </Card>
            </Grid>
          ))}
        </Grid>

        {filterPopUp()}
      </PageContainer>
    </div>
  );
};

export default Tutorials;
